CREATE TABLE DBO.BUFFEROBJECTS 
(FECHA DATETIME DEFAULT(GETDATE()),
                 DBNAME VARCHAR(255),
				 OBJETO VARCHAR(255),
                 TIPO VARCHAR(255),
				 BUFFERPAGES INT,
				 BUFFERMB INT)
GO
 
INSERT INTO DBO.BUFFEROBJECTS  
(DBNAME,OBJETO,TIPO,BUFFERPAGES,BUFFERMB)  
EXEC MASTER.SYS.SP_MSFOREACHDB ' USE [?]
;WITH SRC AS
(
SELECT
[OBJECT] = O.NAME,
[TYPE] = O.TYPE_DESC,
[INDEX] = COALESCE(I.NAME, ''''),
[INDEX_TYPE] = I.TYPE_DESC,
P.[OBJECT_ID],
P.INDEX_ID,
AU.ALLOCATION_UNIT_ID
FROM SYS.PARTITIONS AS P
INNER JOIN SYS.ALLOCATION_UNITS AS AU
ON P.HOBT_ID = AU.CONTAINER_ID
INNER JOIN SYS.OBJECTS AS O
ON P.[OBJECT_ID] = O.[OBJECT_ID]
INNER JOIN SYS.INDEXES AS I
ON O.[OBJECT_ID] = I.[OBJECT_ID]
AND P.INDEX_ID = I.INDEX_ID
WHERE AU.[TYPE] IN (1,2,3) AND O.IS_MS_SHIPPED = 0
)
SELECT
DB_NAME(),SRC.[OBJECT],SRC.[TYPE],
BUFFER_PAGES = COUNT_BIG(B.PAGE_ID),
BUFFER_MB = COUNT_BIG(B.PAGE_ID) / 128
FROM SRC INNER JOIN SYS.DM_OS_BUFFER_DESCRIPTORS AS B
ON SRC.ALLOCATION_UNIT_ID = B.ALLOCATION_UNIT_ID
WHERE B.DATABASE_ID = DB_ID()
GROUP BY SRC.[OBJECT],SRC.[TYPE]
ORDER BY BUFFER_PAGES DESC; '
GO